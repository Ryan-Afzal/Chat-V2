@using Microsoft.AspNetCore.Identity
@using Chat_V2.Areas.Identity.Data
@using Microsoft.AspNetCore.SignalR
@inject SignInManager<ChatUser> SignInManager
@inject UserManager<ChatUser> UserManager

    <ul class="navbar-nav">
        @if (SignInManager.IsSignedIn(User)) {
            <li class="nav-item">
                <a id="manage" class="nav-link text-dark" asp-area="Identity" asp-page="/Account/Manage/Index" title="Manage">Hello @UserManager.GetUserName(User)!</a>
            </li>
            <li class="nav-item">
                <a id="profile" class="nav-link text-dark" asp-page="/Profile" asp-route-userId="@UserManager.GetUserId(User)" title="Profile">Profile</a>
                <span id="notif-new"></span>
            </li>
            <li class="nav-item">
                <form id="logoutForm" class="form-inline" asp-area="Identity" asp-page="/Account/Logout" asp-route-returnUrl="@Url.Page("/Index", new { area = "" })">
                    <button id="logout" type="submit" class="nav-link btn btn-link text-dark">Logout</button>
                </form>
            </li>
        } else {
            <li class="nav-item">
                <a class="nav-link text-dark" id="register" asp-area="Identity" asp-page="/Account/Register">Register</a>
            </li>
            <li class="nav-item">
                <a class="nav-link text-dark" id="login" asp-area="Identity" asp-page="/Account/Login">Login</a>
            </li>
        }
    </ul>
    @if (SignInManager.IsSignedIn(User)) {
        <script>
            "use strict";

            //Start SignalR connection
            const notifConnection = new signalR.HubConnectionBuilder()
                .withUrl("/notifHub")
                .configureLogging(signalR.LogLevel.Information)
                .build();
            
            //On connection established
            notifConnection.start().then(function () {
                console.log("connected to notification hub");
            }).catch(function (err) {
                return console.error(err.toString());
            });

            notifConnection.on("NewNotification", function (args) {
                //New Notification
                var newBadge = document.createElement("span");
                newBadge.setAttribute("class", "badge badge-primary");
                newBadge.textContent = "NEW";

                var node = document.getElementById("notif-new");

                if (!node.hasChildNodes()) {
                    node.appendChild(newBadge);
                }
            });
        </script>
    }