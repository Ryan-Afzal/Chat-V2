@page
@model Chat_V2.Pages.GroupModel
@using Chat_V2.Models
@{
    ViewData["Title"] = "Group " + Model.ViewModel.Group.Name;
    Layout = "~/Pages/Shared/_Layout.cshtml";
}

<h1>Group <span id="group-name-label">@(Model.ViewModel.Group.Name)</span></h1>

<div id="group-data" class="container-fluid">
    <div class="row">
        <div class="col-12 text-center">
            @{
                string img64 = Convert.ToBase64String(Model.ViewModel.Group.GroupImage.Data);
                string img64Url = string.Format("data:image/" + Model.ViewModel.Group.GroupImage.ContentType + ";base64,{0}", img64); //ContentType can be gif, jpeg, png etc.
            }
            <img src="@img64Url" width="256" height="256" class="img-thumbnail" />
        </div>
    </div>
    <dl class="row">
        <dt class="col-sm-2">
            @Html.DisplayNameFor(model => model.ViewModel.Group.GroupID)
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.ViewModel.Group.GroupID)
        </dd>
        <dt class="col-sm-2">
            @Html.DisplayNameFor(model => model.ViewModel.Group.Name)
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.ViewModel.Group.Name)
        </dd>
        <dt class="col-sm-2">
            @Html.DisplayNameFor(model => model.ViewModel.Group.Description)
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.ViewModel.Group.Description)
        </dd>
        <dt class="col-sm-2">
            @Html.DisplayNameFor(model => model.ViewModel.Group.DateCreated)
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.ViewModel.Group.DateCreated)
        </dd>
        <dt class="col-sm-2">
            @Html.DisplayNameFor(model => model.ViewModel.Group.IsPrivate)
        </dt>
        <dd class="col-sm-10">
            @Html.DisplayFor(model => model.ViewModel.Group.IsPrivate)
        </dd>
        <dt class="col-sm-2">
            @Html.DisplayNameFor(model => model.ViewModel.Group.Memberships)
        </dt>

        <dd class="col-sm-10" id="group-member-list">
            <table class="table">
                <tr>
                    <th>ID</th>
                    <th>UserName</th>
                    <th>Rank</th>
                    @if (Model.ViewModel.IsGroupMember) {
                        <th>Status</th>
                    }
                </tr>
                @foreach (var item in Model.ViewModel.Group.Memberships.OrderByDescending(membership => membership.Rank)) {
                    <tr>
                        <td>
                            @Html.DisplayFor(modelItem => item.ChatUser.Id)
                        </td>
                        <td>
                            @Html.DisplayFor(modelItem => item.ChatUser.UserName)
                        </td>
                        <td>
                            @{
                                PermissionRank rank = PermissionRank.GetPermissionRankByOrdinal(item.Rank);
                            }
                            <span class="badge" style="background-color: @rank.Color">@rank.Name</span>
                        </td>
                        @if (Model.ViewModel.IsGroupMember) {
                            <td>
                                @Html.DisplayFor(modelItem => item.MembershipStatus.Type)
                            </td>
                        }
                        <td>
                            <a asp-page="/Profile" asp-route-userId="@item.ChatUserID">View</a>
                        </td>
                    </tr>
                }
            </table>
        </dd>
    </dl>
</div>
<hr />
<div class="container-fluid">
    @if (Model.ViewModel.IsGroupMember) {
        <hr />
        <div id="group-member-user" class="row">
            @if (Model.ViewModel.Membership.Rank == PermissionRank.OWNER.Ordinal) {
                <button id="leave-group" class="btn disabled btn-danger">Leave Group</button>
            } else {
                <button id="leave-group" class="btn btn-danger" data-toggle="modal" data-target="#leaveGroupConfirmModal">Leave Group</button>
            }

            <div class="modal fade" id="leaveGroupConfirmModal" tabindex="-1" role="dialog" aria-labelledby="leaveGroupModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="leaveGroupModalLabel">Are you sure you want to leave this group?</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            This cannot be undone!
                        </div>
                        <div class="modal-footer">
                            <form asp-route-returnUrl="@(HttpContext.Request.Path + HttpContext.Request.Query)" method="post">
                                <button type="button" class="btn btn-dark" data-dismiss="modal">Cancel</button>
                                <button type="submit" asp-page-handler="LeaveGroup" class="btn btn-danger">Leave Group</button>
                                <input type="hidden" asp-for="LeaveGroupInput.ChatUserID" value="@(Model.ViewModel.ChatUser.Id)" />
                                <input type="hidden" asp-for="LeaveGroupInput.GroupID" value="@(Model.ViewModel.Group.GroupID)" />
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        @if (Model.ViewModel.Membership.Rank > PermissionRank.USER.Ordinal) {
            <hr />
            <div id="group-member-moderator" class="row">
                <h4>Join Requests</h4>
                <div id="join-requests-list" class="col-12">
                    @if (Model.ViewModel.Group.GroupJoinRequests.Count == 0) {
                        <div id="no-requests" class="card">
                            <div class="card-header">No Join Requests</div>
                        </div>
                    } else {
                        @foreach (var request in Model.ViewModel.Group.GroupJoinRequests) {
                            <div id="request-user-@(request.ChatUserID)" class="card">
                                <div class="card-header">@(request.ChatUser.UserName)</div>
                                <div class="card-body">
                                    <dl>
                                        <dt>
                                            ID
                                        </dt>
                                        <dh>
                                            @(request.ChatUserID)
                                        </dh>
                                        <dt>
                                            Username
                                        </dt>
                                        <dh>
                                            @(request.ChatUser.UserName)
                                        </dh>
                                        <dt>
                                            Message
                                        </dt>
                                        <dh>
                                            @(request.Message)
                                        </dh>
                                    </dl>
                                    <form asp-route-returnUrl="@(HttpContext.Request.Path + HttpContext.Request.Query)" method="post">
                                        <button type="submit" asp-page-handler="AcceptJoinRequest" class="btn btn-success">Accept</button>
                                        <button type="submit" asp-page-handler="RejectJoinRequest" class="btn btn-danger">Reject</button>
                                        <input type="hidden" asp-for="JoinRequestInput.GroupID" value="@(request.GroupID)" />
                                        <input type="hidden" asp-for="JoinRequestInput.RequestID" value="@(request.GroupJoinRequestID)" />
                                    </form>
                                </div>
                                <div class="card-footer text-muted">@(request.DateSent.ToString())</div>
                            </div>
                        }
                    }
                </div>

                <br />

                <h4>Invite Members</h4>
                <div id="invite-members" class="col-12">
                    <form asp-route-returnUrl="@(HttpContext.Request.Path + HttpContext.Request.Query)" method="post">
                        <div class="text-danger">Remember that the User ID and the username must match the same User!</div>
                        <div asp-validation-summary="All" class="text-danger"></div>
                        <div class="form-group">
                            <label asp-for="InviteToGroupInput.UserID"></label>
                            <input asp-for="InviteToGroupInput.UserID" class="form-control" />
                            <span asp-validation-for="InviteToGroupInput.UserID" class="text-danger"></span>
                        </div>
                        <div class="form-group">
                            <label asp-for="InviteToGroupInput.UserName"></label>
                            <input asp-for="InviteToGroupInput.UserName" class="form-control" />
                            <span asp-validation-for="InviteToGroupInput.UserName" class="text-danger"></span>
                        </div>
                        <div class="form-group">
                            <label asp-for="InviteToGroupInput.Message"></label>
                            <input asp-for="InviteToGroupInput.Message" class="form-control" />
                            <span asp-validation-for="InviteToGroupInput.Message" class="text-danger"></span>
                        </div>
                        <button asp-page-handler="InviteToGroup" type="submit" class="btn btn-primary">Invite</button>
                        <input type="hidden" asp-for="InviteToGroupInput.GroupID" value="@(Model.ViewModel.Group.GroupID)" />
                    </form>
                </div>

                <h4>Banned Users</h4>
                <table class="table">
                    <tr>
                        <th>ID</th>
                        <th>Username</th>
                    </tr>
                    @foreach (var item in Model.ViewModel.Group.BannedUsers) {
                        <tr>
                            <td>
                                @Html.DisplayFor(modelItem => item.Id)
                            </td>
                            <td>
                                @Html.DisplayFor(modelItem => item.UserName)
                            </td>
                            <td>
                                <a asp-page="/Profile" asp-route-userId="@item.Id">View</a>
                            </td>
                            @if (Model.ViewModel.Membership.Rank > PermissionRank.MODERATOR.Ordinal) {
                                <td>
                                    <form asp-route-returnUrl="@(HttpContext.Request.Path + HttpContext.Request.Query)" method="post">
                                        <button type="submit" asp-page-handler="UnbanUser" class="btn btn-primary">Unban</button>
                                        <input type="hidden" asp-for="UnbanUserInput.ChatUserID" value="@item.Id" />
                                        <input type="hidden" asp-for="UnbanUserInput.GroupID" value="@(Model.ViewModel.Group.GroupID)" />
                                    </form>
                                </td>
                            }
                        </tr>
                    }
                </table>
            </div>
            @if (Model.ViewModel.Membership.Rank > PermissionRank.MODERATOR.Ordinal) {
                <hr />
                <div id="group-member-officer" class="row">
                    <h4>Ban User by Id</h4>
                    <div class="col-12">
                        <form asp-route-returnUrl="@(HttpContext.Request.Path + HttpContext.Request.Query)" method="post">
                            <input asp-for="BanUserInput.ChatUserID" class="form-control" />
                            <button type="submit" asp-page-handler="BanUser" class="btn btn-warning">Ban User</button>
                            <input type="hidden" asp-for="BanUserInput.GroupID" value="@(Model.ViewModel.Group.GroupID)" />
                        </form>
                    </div>
                </div>
                @if (Model.ViewModel.Membership.Rank > PermissionRank.OFFICER.Ordinal) {
                    <hr />
                    <div id="group-member-admin" class="row">
                        <div id="change-image" class="col-12">
                            <h4>Change Image</h4>
                            <form asp-route-returnUrl="@(HttpContext.Request.Path + HttpContext.Request.Query)" enctype="multipart/form-data" method="post">
                                <dl>
                                    <dt>
                                        <label asp-for="UploadImageInput.GroupImage"></label>
                                    </dt>
                                    <dd>
                                        <input asp-for="UploadImageInput.GroupImage" type="file">
                                    </dd>
                                </dl>
                                <input asp-page-handler="UploadImage" class="btn btn-primary" type="submit" value="Upload">
                                <input type="hidden" asp-for="UploadImageInput.GroupID" value="@(Model.ViewModel.Group.GroupID)" />
                            </form>
                        </div>
                        <div id="toggle-private-public" class="col-12">
                            <h4>Toggle Private Group</h4>
                            @if (Model.ViewModel.Group.IsPrivate) {
                                <button id="private-public toggle" class="btn btn-info" data-toggle="modal" data-target="#privatepublicConfirmModal">Make Group Public</button>

                                <div class="modal fade" id="privatepublicConfirmModal" tabindex="-1" role="dialog" aria-labelledby="privatepublicConfirmModalLabel" aria-hidden="true">
                                    <div class="modal-dialog" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="privatepublicConfirmModalLabel">Are you sure you want to make this group public?</h5>
                                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                    <span aria-hidden="true">&times;</span>
                                                </button>
                                            </div>
                                            <div class="modal-body">
                                                This will make it discoverable by non-users, and allow them to make join requests.
                                            </div>
                                            <div class="modal-footer">
                                                <form asp-route-returnUrl="@(HttpContext.Request.Path + HttpContext.Request.Query)" method="post">
                                                    <button type="button" class="btn btn-dark" data-dismiss="modal">Cancel</button>
                                                    <button type="submit" asp-page-handler="MakePublic" class="btn btn-info">Make Public</button>
                                                    <input type="hidden" asp-for="PublicPrivateInput.GroupID" value="@(Model.ViewModel.Group.GroupID)" />
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            } else {
                                <button id="private-public toggle" class="btn btn-info" data-toggle="modal" data-target="#privatepublicConfirmModal">Make Group Private</button>

                                <div class="modal fade" id="privatepublicConfirmModal" tabindex="-1" role="dialog" aria-labelledby="privatepublicConfirmModalLabel" aria-hidden="true">
                                    <div class="modal-dialog" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="privatepublicConfirmModalLabel">Are you sure you want to make this group private?</h5>
                                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                    <span aria-hidden="true">&times;</span>
                                                </button>
                                            </div>
                                            <div class="modal-body">
                                                This will make it undiscoverable by non-users, and disallow join requests.
                                            </div>
                                            <div class="modal-footer">
                                                <form asp-route-returnUrl="@(HttpContext.Request.Path + HttpContext.Request.Query)" method="post">
                                                    <button type="button" class="btn btn-dark" data-dismiss="modal">Cancel</button>
                                                    <button type="submit" asp-page-handler="MakePrivate" class="btn btn-danger">Make Private</button>
                                                    <input type="hidden" asp-for="PublicPrivateInput.GroupID" value="@(Model.ViewModel.Group.GroupID)" />
                                                </form>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                    @if (Model.ViewModel.Membership.Rank > PermissionRank.ADMINISTRATOR.Ordinal) {
                        <hr />
                        <div id="group-member-owner" class="row">
                            <div class="card border-danger">
                                <div class="card-header text-danger">
                                    Change Ownership
                                </div>
                                <div class="card-body">
                                    <!--<form asp-route-returnUrl="@(HttpContext.Request.Path + HttpContext.Request.Query)" method="post" class="form-group">
                                        <div asp-validation-summary="All" class="text-danger"></div>
                                        <div class="form-group">
                                            <label asp-for="ChangeOwnerInput.UserID"></label>
                                            <input asp-for="ChangeOwnerInput.UserID" class="form-control" />
                                            <span asp-validation-for="ChangeOwnerInput.UserID" class="text-danger"></span>
                                        </div>
                                        <div class="form-group">
                                            <label asp-for="ChangeOwnerInput.UserName"></label>
                                            <input asp-for="ChangeOwnerInput.UserName" class="form-control" />
                                            <span asp-validation-for="ChangeOwnerInput.UserName" class="text-danger"></span>
                                        </div>
                                        <button asp-page-handler="ChangeOwner" type="submit" class="btn btn-danger">Change Owner</button>
                                        <input asp-for="ChangeOwnerInput.GroupID" value="@(Model.ViewModel.Group.GroupID)" />
                                    </form>-->
                                </div>
                            </div>

                            <div class="card border-danger">
                                <div class="card-header text-danger">
                                    Danger Zone
                                </div>
                                <div class="card-body">
                                    <form method="post" class="form-group">
                                        <button type="submit" asp-page-handler="ArchiveGroup" class="btn btn-warning disabled">Archive</button>
                                        <button type="submit" asp-page-handler="DeleteGroup" class="btn btn-danger disabled">Delete</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        @if (Model.ViewModel.Membership.Rank > PermissionRank.OWNER.Ordinal) {
                            <hr />
                            <div id="group-member-superuser" class="row">

                            </div>
                        }
                    }
                }
            }
        }
    } else {
        @if (Model.ViewModel.IsBanned) {
            <div id="not-group-memeber" class="row">
                <div class="col-12">
                    <h3>You are banned from this group.</h3>
                </div>
            </div>
        } else {
            <div id="not-group-member" class="row">
                <div class="col-12">
                    @if (Model.ViewModel.JoinRequestSent) {
                        <h3>You have sent a join request.</h3>
                    } else {
                        <h3>You are not a group member. To become a group member, send a join request.</h3>
                        <form asp-route-returnUrl="@(HttpContext.Request.Path + HttpContext.Request.Query)" method="post">
                            <div class="form-group">
                                <label asp-for="SendJoinRequestInput.Message"></label>
                                <textarea asp-for="SendJoinRequestInput.Message" class="form-control"></textarea>
                            </div>
                            <input type="hidden" asp-for="SendJoinRequestInput.ChatUserID" value="@(Model.ViewModel.ChatUser.Id)" />
                            <input type="hidden" asp-for="SendJoinRequestInput.GroupID" value="@(Model.ViewModel.Group.GroupID)" />
                            <button id="send-join-request" type="submit" asp-page-handler="SendJoinRequest" class="btn btn-primary">Send</button>
                        </form>
                    }
                </div>
            </div>
        }
    }
</div>
<style>

    #group-member-list {
    }

    #group-member-owner {
        display: block;
    }
</style>