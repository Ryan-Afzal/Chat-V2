"use strict";function isMobile(){return window.innerWidth<=800&&window.innerHeight<=600?!0:!1}function appendMessage(n){var t=$("#messages-list"),i=$("#messages-list-container");t.append(n);i.scrollTop(t[0].scrollHeight)}function prependMessage(n){var t=$("#messages-list"),i=$("#messages-list-container");t.prepend(n);i.scrollTop(t[0].scrollHeight)}function getMessageFromArgs(n){var u=document.createElement("div"),f,e,o,t,r,i,s,l,h,c;return u.setAttribute("class","message"),f=document.createElement("div"),f.setAttribute("class","message-image-inner"),u.append(f),e=document.createElement("div"),e.setAttribute("class","message-image"),f.append(e),o=document.createElement("div"),o.setAttribute("class","message-image-inner"),e.append(o),t=document.createElement("img"),t.setAttribute("src",n.userImage),t.setAttribute("width",32),t.setAttribute("height",32),t.setAttribute("class","rounded-circle img"),o.append(t),r=document.createElement("div"),r.setAttribute("class","message-container"),u.append(r),i=document.createElement("div"),i.setAttribute("class","message-header"),r.append(i),s=document.createElement("span"),s.setAttribute("class","message-username"),s.textContent=n.userName,i.append(s),l=document.createElement("span"),l.innerHTML="&nbsp;&nbsp;&nbsp;",i.append(l),h=document.createElement("span"),h.setAttribute("class","message-timestamp text-muted"),h.textContent=n.timestamp,i.append(h),c=document.createElement("span"),c.setAttribute("class","message-content"),c.textContent=n.message,r.append(c),u}function clearMessages(){$("#messages-list").empty()}function userConnected(n,t,i,r){var f=document.createElement("li"),u,e,o,s;f.setAttribute("id","user-"+n);f.setAttribute("class","user-data-container list-group-item");u=document.createElement("img");u.setAttribute("src",i);isMobile?(u.setAttribute("width","16"),u.setAttribute("height","16")):(u.setAttribute("width","32"),u.setAttribute("height","32"));u.setAttribute("class","rounded-circle img");f.appendChild(u);e=document.createElement("span");e.setAttribute("class","user-data-name");isMobile&&hide(e);e.textContent=t+" ";f.appendChild(e);o=document.createElement("span");o.setAttribute("class","badge badge-dark text-wrap");isMobile&&hide(o);o.textContent="    "+r;f.appendChild(o);document.getElementById("online-members-list").appendChild(f);s=document.getElementById("current-group-online-count");s.textContent=parseInt(s.textContent)+1}function userConnectedToPersonalGroup(){var n=document.getElementById("current-group-personal-online");n.textContent="Online";n.setAttribute("class","badge bg-primary")}function userDisconnected(n){document.getElementById("online-members-list").removeChild(document.getElementById("user-"+n));var t=document.getElementById("current-group-online-count");t.textContent=parseInt(t.textContent)-1}function userDisconnectedFromPersonalGroup(){var n=document.getElementById("current-group-personal-online");n.textContent="Offline";n.setAttribute("class","badge bg-danger")}function userActive(n){document.getElementById("user-"+n).setAttribute("class","list-group-item user-data-container")}function userActiveInPersonalGroup(){var n=document.getElementById("current-group-personal-online");n.textContent="Active";n.setAttribute("class","badge bg-success")}function userInactive(n){document.getElementById("user-"+n).setAttribute("class","list-group-item list-group-item-primary user-data-container user-data-container-inactive")}function userInactiveInPersonalGroup(){var n=document.getElementById("current-group-personal-online");n.textContent="Online";n.setAttribute("class","badge bg-primary")}function clearUsers(){$("#online-members-list").empty()}function userTyping(){}function userNotTyping(){}function clearTyping(){}function updateGroupData(n,t,i){var f,r,u;show(document.getElementById("current-group-data"));f=document.getElementById("current-group-name");f.textContent=t;f.setAttribute("href","/Group?groupID="+n);r=document.getElementById("current-group-members-count");r.textContent=i;u=document.getElementById("current-group-online-count");u.textContent="1";isMobile?(hide(document.getElementById("current-group-members")),hide(document.getElementById("current-group-online")),hide(r),hide(u)):(show(document.getElementById("current-group-members")),show(document.getElementById("current-group-online")),show(r),show(u))}function updatePersonalGroupData(n,t,i){var u,f,r;show(document.getElementById("current-group-data-personal"));u=document.getElementById("current-group-name");u.textContent=t;u.setAttribute("href","/Profile?userID="+n);f=document.getElementById("current-group-personal-userName");f.textContent=t;r=document.getElementById("current-group-personal-userImage");r.setAttribute("src",i);isMobile?(r.setAttribute("width",32),r.setAttribute("height",32)):(r.setAttribute("width",128),r.setAttribute("height",128))}function clearData(){var n=document.getElementById("current-group-name");n.textContent="No Group Selected";n.setAttribute("groupID",-1);document.getElementById("current-group-members-count").textContent="N/A";document.getElementById("current-group-online-count").textContent="N/A";hide(document.getElementById("current-group-data"));hide(document.getElementById("current-group-data-personal"))}function clear(){if(clearMessages(),clearUsers(),clearTyping(),clearData(),membershipID!=-1){var n={MembershipID:membershipID};connection.invoke("DisconnectedFromGroup",n)}numMessages=0;currentGroupID=-1;membershipID=-1}function newGroupMessage(n,t){var i=document.getElementById("group-data-new-"+n);i.textContent=t;show(i)}function removeNewGroupMessage(n){hide(document.getElementById("group-data-new-"+n))}function switchGroupTo(n,t){clear();currentGroupID=n;membershipID=t;var i={MembershipID:membershipID};connection.invoke("ConnectedToGroup",i);connection.invoke("ActiveInGroup",i);removeNewGroupMessage(n)}function addGroup(n,t,i,r,u){var f=document.createElement("li"),e,s,o,h;f.setAttribute("class","group-data-container list-group-item");f.setAttribute("id","group-"+n);f.setAttribute("groupId",n);f.setAttribute("membershipId",u);f.addEventListener("click",function(){switchGroupTo(parseInt(f.getAttribute("groupId")),parseInt(f.getAttribute("membershipId")))});e=document.createElement("img");e.setAttribute("src",t);isMobile?(e.setAttribute("width","16"),e.setAttribute("height","16")):(e.setAttribute("width","32"),e.setAttribute("height","32"));e.setAttribute("class","rounded-circle img");f.appendChild(e);s=document.createElement("span");s.setAttribute("class","group-data-name");isMobile&&hide(s);s.textContent=r+" ";f.appendChild(s);o=document.createElement("span");o.setAttribute("id","group-data-new-"+n);o.setAttribute("class","badge badge-success");hide(o);o.textContent="NEW";f.appendChild(o);h=document.getElementById("groups-list");h.append(f);i>0&&newGroupMessage(n,i)}function removeGroup(n){document.getElementById("groups-list").removeChild(document.getElementById("group-"+n));n==currentGroupID&&clear()}function loadPreviousMessages(n,t){var i={MembershipID:membershipID,StartIndex:n,Count:t};connection.invoke("GetPreviousMessages",i)}var isMobile=isMobile();let sound=new Audio("/media/new-message.mp3");var play_sound=!1,numMessages=0,currentGroupID=-1,membershipID=-1;isMobile?(show(document.getElementById("left-header-mobile")),hide(document.getElementById("left-header-desktop"))):(hide(document.getElementById("left-header-mobile")),show(document.getElementById("left-header-desktop")));const connection=(new signalR.HubConnectionBuilder).withUrl("/chatHub").configureLogging(signalR.LogLevel.Information).build();connection.onclose(function(){var t=document.getElementById("head-row"),n=document.createElement("div");n.setAttribute("class","alert alert-danger w-100");n.setAttribute("role","alert");n.textContent="Your connection has closed. Refresh the page to reconnect.";t.append(n)});connection.start().then(function(){console.log("connected to chat hub");var n={UserID:viewmodel.UserID};connection.invoke("Connected",n).catch(function(n){return console.error(n.toString())})}).catch(function(n){return console.error(n.toString())});let isTypingCallback=debounce(function(){var n={MembershipID:membershipID};connection.invoke("UserTyping",n)},600,!0);window.addEventListener("unload",function(){clear();var n={UserID:viewmodel.UserID};connection.invoke("Disconnected",n)});window.addEventListener("focus",function(){if(membershipID!=-1){var n={MembershipID:membershipID};connection.invoke("ActiveInGroup",n)}play_sound=!1});window.addEventListener("blur",function(){if(membershipID!=-1){var n={MembershipID:membershipID};connection.invoke("InactiveInGroup",n)}play_sound=!0});document.getElementById("load-previous-messages-button").addEventListener("click",function(){membershipID!=-1&&loadPreviousMessages(numMessages,50)});connection.on("ReceivePreviousMessages",function(n){$.each(n,function(){var n=this;prependMessage(getMessageFromArgs(n));numMessages++})});connection.on("ReceiveMessage",function(n){if(n.groupID==currentGroupID?(appendMessage(getMessageFromArgs(n)),numMessages++):newGroupMessage(n.groupID),n.UserID!=viewmodel.UserID){play_sound&&sound.play();var t=document.getElementById("group-"+n.groupID),i=document.getElementById("groups-list");i.removeChild(t);i.prepend(t)}});document.getElementById("message-input").addEventListener("keydown",function(n){var t=document.getElementById("message-input"),i=t.textContent,r;i.trim()==""||n.key!="Enter"||n.shiftKey||currentGroupID==-1||(r={MembershipID:membershipID,MinRank:0,Message:i,Multimedia:null},connection.invoke("SendMessage",r).catch(function(n){return console.error(n.toString())}),t.textContent="",n.preventDefault())});document.getElementById("message-input").addEventListener("keydown",isTypingCallback);connection.on("ReceiveGroupData",function(n){n.groupID==currentGroupID&&updateGroupData(n.groupID,n.groupName,n.numUsers)});connection.on("ReceivePersonalGroupData",function(n){n.groupID==currentGroupID&&updatePersonalGroupData(n.userID,n.userName,n.userImage)});connection.on("OtherUserConnectedToGroup",function(n){n.userID!=parseInt(viewmodel.UserID)&&n.groupID==currentGroupID&&userConnected(n.userID,n.userName,n.userImage,n.userRank)});connection.on("OtherUserConnectedToPersonalGroup",function(n){n.userID!=parseInt(viewmodel.UserID)&&n.groupID==currentGroupID&&userConnectedToPersonalGroup(n.groupID,n.userID)});connection.on("OtherUserDisconnectedFromGroup",function(n){n.userID!=parseInt(viewmodel.UserID)&&n.groupID==currentGroupID&&userDisconnected(n.userID)});connection.on("OtherUserDisconnectedFromPersonalGroup",function(n){n.userID!=parseInt(viewmodel.UserID)&&n.groupID==currentGroupID&&userDisconnectedFromPersonalGroup(n.userID)});connection.on("OtherUserActiveInGroup",function(n){n.userID!=parseInt(viewmodel.UserID)&&n.groupID==currentGroupID&&userActive(n.userID)});connection.on("OtherUserInactiveInGroup",function(n){n.userID!=parseInt(viewmodel.UserID)&&n.groupID==currentGroupID&&userInactive(n.userID)});connection.on("OtherUserActiveInPersonalGroup",function(n){n.userID!=parseInt(viewmodel.UserID)&&n.groupID==currentGroupID&&userActiveInPersonalGroup(n.userID)});connection.on("OtherUserInactiveInPersonalGroup",function(n){n.userID!=parseInt(viewmodel.UserID)&&n.groupID==currentGroupID&&userInactiveInPersonalGroup(n.userID)});connection.on("AddGroup",function(n){addGroup(n.groupID,n.groupImage,n.numNew,n.groupName,n.membershipID)});connection.on("RemoveGroup",function(n){removeGroup(n.groupID)});connection.on("ClientBannedFromGroup",function(n){removeGroup(n.groupID)});connection.on("OtherUserTyping",function(n){n.groupID==currentGroupID&&userTyping(n.userID,n.userProfileImage)});connection.on("OtherUserNotTyping",function(n){n.groupID==currentGroupID&&userNotTyping(n.userID)});